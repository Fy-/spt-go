  {{if eq .RunMode "dev"}}
    {{template "debug.html" .}}
  {{end}}

  
  <script src="js/jquery-3.2.1.min.js"></script>
  <script src="js/tippy.js"></script>
  <script src="js/popper.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.highlight.js"></script>
  {{range .moreScripts}}
    <script src="/public/{{.}}" type="text/javascript" charset="utf-8"></script>
  {{end}}
  <script>

      $('#postContent').keypress(function(e){
          if(e.keyCode === 13 && !e.shiftKey) {
              e.preventDefault();
              this.form.submit();
          }
      });

      $('#commentContent').keypress(function(e){
          if(e.keyCode === 13 && !e.shiftKey) {
              e.preventDefault();
              this.form.submit();
          }
      });

      $('#edit').keypress(function(e){
          if(e.keyCode === 13 && !e.shiftKey) {
              e.preventDefault();
              this.form.submit();
          }
      });

      $(document).ready(function(){        
          
        tippy(".userLink");
        tippy(".followLink");

        $("#followBtn").click(function(e){
            var sel = $(this);
            var count = parseInt($("#followCount").text());
            e.preventDefault();
            $.ajax({
                type: "post",
                url: "follow.php",
                data: {
                    "toFollow": $(this).data("user-id")
                },
                success: function (response) {
                    if(response === "1"){
                        sel.removeClass("btn-primary");
                        sel.addClass("btn-secondary");
                        sel.html("<i class='fa fa-frown-o'></i> Unfollow")
                        $("#followCount").text(count + 1)
                    } else if(response === "0"){
                        sel.removeClass("btn-secondary");
                        sel.addClass("btn-primary");
                        sel.html("<i class='fa fa-smile-o'></i> Follow")
                        $("#followCount").text(count - 1)
                    }
                }
            });
        });

        $("#liveSearchUser").on('input', function(){
            var searchData = {}
            if($(this).val() === ""){
                $("#liveResult").hide();
                return;
            }
            $("#liveResult tbody").html("")
            searchData.search = $(this).val();
            $.ajax({
                type: "post",
                url: "live-search.php",
                data: searchData,
                success: function (response) {
                    if (response === "") {
                        $("#liveResult").hide();
                        return;
                    }
                    var users = response.split(",");
                    users = users.filter(entry => /\S/.test(entry));
                    if(users.length <= 0){
                        $("#liveResult tbody").append("<tr class='row'><td class='td-id'>&nbsp;</td><td class='td-username'>&nbsp;</td><td class='td-email'>&nbsp;</td><td>&nbsp;</td></tr>")
                    }
                    $("#liveResult").show();
                    users.forEach(function(u){
                        var infos = u.split(";")
                        var id = infos[0];
                        var username = infos[1]
                        var email = infos[2]
                        $("#liveResult tbody").append("<tr class='row'><td class='col-md-1 td-id'>"+id+"</td><td class='col-md-5 td-username'>"+username+"</td><td class='col-md-5 td-email'>"+email+"</td><td class='col-md-1'><a href='display-user.php?id="+id+"' class='btn btn-primary'><i class='fa fa-user'></i></a></td></tr>")
                        $(".td-username, .td-email").highlight(searchData.search);
                    });
                }
            });
        });

          $(".followLink").click(function(e){
            e.preventDefault();
            var sel = $(this);
            var nb = $(this).data("user-id");
            $.ajax({
                type: "post",
                url: "follow.php",
                data: {
                    "toFollow": nb
                },
                success: function (response) {
                    if(response === "1"){
                        $.each($(".followLink[data-user-id='"+nb+"']"), function (indexInArray, el) { 
                            $(el).html("<i class='fa fa-frown-o'></i>");
                        });
                    } else if(response === "0"){
                        $.each($(".followLink[data-user-id='"+nb+"']"), function (indexInArray, el) {
                            $(el).html("<i class='fa fa-smile-o'></i>");
                        });
                    }
                }
            });
          });

          $("a[data-action='comment']").click(function(e) {
              e.preventDefault();
            $(this).parent(".media-body").find("#commentBlock").slideDown(500);
          });

          $("a[data-action='like']").click(function(e){
          e.preventDefault();
          var post_id = $(this).parent(".media-body").data("post-id");
          var comment_id = $(this).parent(".media-body").data("comment-id");
          var sel = undefined;
          if(post_id !== undefined)
              sel = $(this).parent(".media-body").find("#post-likes");
          if(comment_id !== undefined)
              sel = $(this).parent(".media-body").find("#comment-likes");
          var a = $(this);
          var dat = {};
          console.log(post_id+", "+comment_id);
          if(post_id !== undefined) dat.post_id = post_id;
          if(comment_id !== undefined) dat.comment_id = comment_id;
          $.ajax({
              type: "POST",
              url: "like.php",
              data: dat,
              success: function(data) {
                  sel.text(data);
                  a.html(a.html() === "<i class=\"fa fa-thumbs-down\"></i>" ? "<i class=\"fa fa-thumbs-up\"></i>" : "<i class=\"fa fa-thumbs-down\"></i>");
              }
          });

      });

        $("a[data-action='edit']").click(function(e) {
            e.preventDefault();
            if($(this).parent(".media-body").data("post-id") !== undefined){
                $(this).parent(".media-body").find("#postContent").hide();
                $(this).parent(".media-body").find(".formEdit").show();
            }
            if($(this).parent(".media-body").data("comment-id") !== undefined){
                $(this).parent(".media-body").find("#commentContent").hide();
                $(this).parent(".media-body").find(".formCommentEdit").show();
            }
        });

        $("a[data-action='delete']").click(function(e){
          e.preventDefault();
          var post_sel = $(this).next("#post");
          var post_id = $(post_sel).find(".media-body").data("post-id");
          var comment_sel = $(this).next("#comment");
          var comment_id = $(comment_sel).find(".media-body").data("comment-id");
          var dat = {};
          if(post_id !== undefined) dat.post_id = post_id;
          if(comment_id !== undefined) dat.comment_id = comment_id;
          $.ajax({
              type: "POST",
              url: "delete.php",
              data: dat,
              success: function(data) {
                  if(post_id !== undefined) $(post_sel).parent(".post").fadeOut("slow");
                  else if(comment_id !== undefined) $(comment_sel).parent(".comment").fadeOut("slow");
              }
          });
        });
        });
  </script>

  </body>
</html>

